<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!--
  ~ This file is part of "hybris integration" plugin for Intellij IDEA.
  ~ Copyright (C) 2014-2016 Alexander Bartash <AlexanderBartash@gmail.com>
  ~
  ~ This program is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU Lesser General Public License as
  ~ published by the Free Software Foundation, either version 3 of the
  ~ License, or (at your option) any later version.
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  ~ See the GNU Lesser General Public License for more details.
  ~
  ~ You should have received a copy of the GNU Lesser General Public License
  ~ along with this program. If not, see <http://www.gnu.org/licenses/>.
  -->

<ruleset>

    <rule type="XPATH"
          id="DeploymentTableMustExistForItemExtendingGenericItem"
          selectionQuery="//itemtype[@extends='GenericItem' or not(@extends)]"
          testQuery="count(./deployment) > 0 or (./@autocreate='false' and ./@generate='false') or ./@abstract='true'"
          nameQuery="./@code"/>

    <!-- The typecode must be unique across all items.xml files. That failes now -->
    <rule type="XPATH"
          id="DeploymentTypeCodeMustBeGreaterThanTenThousand"
          selectionQuery="//itemtype/deployment"
          testQuery="./@typecode > 10000"
          nameQuery="../@code"/>

    <rule type="XPATH" id="NoDeploymentTableShouldExistForItemIfNotExtendingGenericItem"
          selectionQuery="//itemtype[@extends!='GenericItem']"
          testQuery="count(./deployment) = 0"
          nameQuery="./@code"/>

    <rule type="XPATH" id="JaloClassIsNotAllowedWhenAddingFieldsToExistingClass"
          selectionQuery="//itemtype[@autocreate='false' and @generate='false']"
          testQuery="self::node()[not (@jaloclass)]"
          nameQuery="./@code"/>

    <rule type="XPATH"
          id="DeploymentTableMustExistForManyToManyRelation"
          selectionQuery="//relation[sourceElement[@cardinality='many']][targetElement[@cardinality='many']]"
          testQuery="count(./deployment) > 0"
          nameQuery="./@code"/>

    <rule type="XPATH"
          id="DeploymentTypeCodesMustBeGreaterThanTenThousandForRelations"
          selectionQuery="//relation/deployment"
          testQuery="./@typecode > 10000"
          nameQuery="./@code"/>

    <rule type="XPATH"
          id="MandatoryFieldMustHaveInitialValue"
          selectionQuery="//itemtype/attributes/attribute[modifiers[@optional='false']]"
          testQuery="./modifiers/@initial = 'true' or count(./defaultvalue) > 0"
          nameQuery="../../@code|./@qualifier"/>

    <rule type="XPATH"
          id="ImmutableFieldMustHaveInitialValue"
          selectionQuery="//itemtype/attributes/attribute[modifiers[@write='false'] and persistence[@type!='dynamic']]"
          testQuery="./modifiers/@initial = 'true' or count(./defaultvalue) > 0"
          nameQuery="../../@code|./@qualifier"/>

    <rule type="XPATH"
          id="BooleanFieldCannotBeOptional"
          selectionQuery="//itemtype/attributes/attribute[@type='java.lang.Boolean']"
          testQuery="./modifiers/@optional = 'false' or count(./defaultvalue) > 0"
          nameQuery="../../@code|./@qualifier"/>

    <rule type="XPATH"
          id="JaloPersistanceTypeIsDeprecated"
          selectionQuery="//itemtype/attributes/attribute"
          testQuery="count(./persistence) = 0 or ./persistence/@type != 'jalo'"
          nameQuery="../../@code|./@qualifier"/>

    <rule type="XPATH"
          id="CmpPersistanceTypeIsDeprecated"
          selectionQuery="//itemtype/attributes/attribute"
          testQuery="count(./persistence) = 0 or ./persistence/@type != 'cmp'"
          nameQuery="../../@code|./@qualifier"/>

    <rule type="XPATH"
          id="TypeNameMustStartWithUppercaseLetter"
          selectionQuery="//itemtype|//enumtype|//relation"
          testQuery="substring(./@code, 1, 1) = translate(substring(./@code, 1, 1), 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ')"
          nameQuery="./@code"/>

    <rule type="XPATH"
          id="TypeNameMustNotStartWithGenerated"
          selectionQuery="//itemtype|//enumtype|//relation"
          testQuery="not(starts-with(translate(./@code, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'), 'GENERATED'))"
          nameQuery="./@code"/>

    <rule type="XPATH"
          id="FieldNameMustStartWithLowercaseLetter"
          selectionQuery="//itemtype/attributes/attribute"
          testQuery="substring(./@qualifier, 1, 1) = translate(substring(./@qualifier, 1, 1), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz')"
          nameQuery="../../@code|./@qualifier"/>

    <rule type="XPATH"
          id="RelationshipQualifierNameMustStartWithLowercaseLetter"
          selectionQuery="//relation/sourceElement|//relation/targetElement"
          testQuery="substring(./@qualifier, 1, 1) = translate(substring(./@qualifier, 1, 1), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz')"
          nameQuery="../@code|./@qualifier"/>

    <rule type="XPATH"
          id="OrderingOfRelationShouldBeAvoided"
          selectionQuery="//relation/sourceElement[@cardinality='many']|//relation/targetElement[@cardinality='many']"
          testQuery="./@ordered = 'false' or count(./@ordered) = 0"
          nameQuery="../@code|./@qualifier"/>

    <rule type="XPATH"
          id="ListsInRelationShouldBeAvoided"
          selectionQuery="//relation/sourceElement[@cardinality='many']|//relation/targetElement[@cardinality='many']"
          testQuery="./@collectiontype = 'set' or count(./@collectiontype) = 0"
          nameQuery="../@code|./@qualifier"/>

    <rule type="XPATH"
          id="UseOfUnoptimizedAttributesIsNotRecommended"
          selectionQuery="//itemtype/attributes/attribute[modifiers[@dontOptimize = 'true']]"
          testQuery="1 = 0 "
          nameQuery="../../@code|./@qualifier"/>

    <rule type="XPATH"
          id="TypeCodeReservedForCommonsExtension"
          selectionQuery="//itemtype/deployment"
          testQuery="./@typecode &gt; 13199 and ./@typecode &lt; 13300"
          failOnTestQuery="true"
          nameQuery="../@code"/>

    <rule type="XPATH"
          id="TypeCodeReservedForPrintExtension"
          selectionQuery="//itemtype/deployment"
          testQuery="(./@typecode &gt; 23399 and ./@typecode &lt; 23500) or (./@typecode &gt; 238999 and ./@typecode &lt; 24000)"
          failOnTestQuery="true"
          nameQuery="../@code"/>

    <rule type="XPATH"
          id="TypeCodeReservedForProcessingExtension"
          selectionQuery="//itemtype/deployment"
          testQuery="./@typecode &gt; 32699 and ./@typecode &lt; 32800"
          failOnTestQuery="true"
          nameQuery="../@code"/>

    <rule type="XPATH"
          id="TypeCodeReservedForLegacyXPrintExtension"
          selectionQuery="//itemtype/deployment"
          testQuery="./@typecode &gt; 24399 and ./@typecode &lt; 24600"
          failOnTestQuery="true"
          nameQuery="../@code"/>

    <rule type="XPATH"
          id="TypeCodeReservedForB2BCommerceExtension"
          selectionQuery="//itemtype/deployment"
          testQuery="./@typecode &gt; 9999 and ./@typecode &lt; 10100"
          failOnTestQuery="true"
          nameQuery="../@code"/>

    <rule type="XPATH"
          id="CollectionsAreOnlyForDynamicAndJalo"
          selectionQuery="//itemtype/attributes/attribute[@type = //collectiontypes/collectiontype/@code]"
          testQuery="./persistence/@type = 'property'"
          failOnTestQuery="true"
          nameQuery="./@qualifier"/>

    <!-- the selection query will most likely not result in a match for a project; it assumes that the type that is extended is part of the same XML file,
         but this is most likely not the case as customers will extend standard data models (defined in hybris extensions)
    -->
    <rule type="XPATH"
          id="DeploymentForSubclassesOfAbstractClasses"
          selectionQuery="//itemtype[@extends = //itemtype/@code and //itemtype[@extends='GenericItem' and @abstract='true']]"
          testQuery="count(./deployment) = 1"
          nameQuery="./@code">
    </rule>

    <rule type="XPATH"
          id="CatalogAwareTypesMustHaveSpecificConditions"
          selectionQuery="//itemtype/custom-properties/property[@name='catalogItemType']"
          testQuery="count(./value) = 1"
          nameQuery="../../@code">
    </rule>

    <rule type="XPATH"
          id="ConditionForCatalogVersionAttributeQualifier"
          selectionQuery="//itemtype/attributes/attribute[concat('&quot;',@qualifier,'&quot;')=//itemtype/custom-properties/property[@name='catalogVersionAttributeQualifier']/value/text()]"
          testQuery="./modifiers[@optional='false' and @unique='true']"
          nameQuery="./@qualifier">
    </rule>

    <rule type="XPATH"
          id="ConditionForUniqueKeyAttributeQualifier"
          selectionQuery="//itemtype/attributes/attribute[concat('&quot;',@qualifier,'&quot;')=//itemtype/custom-properties/property[@name='uniqueKeyAttributeQualifier']/value/text()]"
          testQuery="./modifiers[@optional='false' and @unique='true']"
          nameQuery="./@qualifier">
    </rule>

</ruleset>
